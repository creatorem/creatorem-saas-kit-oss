---
description: 
globs: 
alwaysApply: true
---
# Next.js Security Guidelines

This guide outlines critical security practices for Next.js applications, focusing on client/server boundaries, authentication, and data protection.

## Client/Server Boundary

### 1. Data Handling
- ❌ Never pass sensitive data to Client Components
- ❌ Never pass unsanitized data to Client Components
- ✅ Always sanitize user input in Server Components
- ✅ Always validate cookies and headers

### 2. Environment Variables
- ✅ Use `import 'server-only'` for server-side code
- ❌ Never expose server-only env vars to client
- ❌ Never pass env vars as props unless prefixed with `NEXT_PUBLIC_`
- ❌ Never use `NEXT_PUBLIC_` for secrets/API keys
- ✅ Use `NEXT_PUBLIC_` only for client-safe data

## Authentication & Authorization

### 1. Database Security
- ✅ Enable Row Level Security on all tables
- ✅ Implement extra validation for admin routes
- ✅ Verify permissions before data access

### 2. Server Actions
- ✅ Add `'use server'` directive at file top
- ✅ Validate input with schema validation (Zod)
- ✅ Include authentication checks

```

## Client Components

### 1. Workspace Context
- ✅ Use appropriate workspace contexts:
  - `useUserWorkspace()` for personal accounts
  - `useTeamAccountWorkspace()` for team accounts

### 2. Permission Checks
- ✅ Check permissions before rendering sensitive UI

Example:
```typescript
function SecureComponent() {
  const { account, user } = useTeamAccountWorkspace();
  const canEdit = account.permissions.includes('entity.update');

  if (!canEdit) return null;
  return <EditComponent />;
}
```

## Error Handling

### 1. Best Practices
- ❌ Never expose internal errors to clients
- ✅ Log errors with context
- ✅ Return generic messages to users

Example:
```typescript
try {
  await sensitiveOperation();
} catch (error) {
  logger.error({ error, context }, 'Operation failed');
  return { error: 'Unable to complete operation' };
}
```

## Database Security

### 1. Query Safety
- ❌ Avoid dynamic SQL generation
- ⚠️ Use SECURITY DEFINER functions cautiously
- ✅ Implement proper foreign key constraints
- ✅ Use appropriate data types with constraints

## Critical Data Protection

### 1. Data Handling
- ❌ Never log sensitive user data (API keys, passwords)
- ✅ Use one-time tokens for destructive operations
- ✅ Implement proper session management

## Implementation Checklist

### 1. New Features
- [ ] Implement proper authentication
- [ ] Add input validation
- [ ] Set up error handling
- [ ] Configure proper permissions
- [ ] Test security measures

### 2. Code Review
- [ ] Check for sensitive data exposure
- [ ] Verify authentication flows
- [ ] Review error handling
- [ ] Validate security measures

Remember: Security is a continuous process. Regularly review and update security measures to protect against new threats.