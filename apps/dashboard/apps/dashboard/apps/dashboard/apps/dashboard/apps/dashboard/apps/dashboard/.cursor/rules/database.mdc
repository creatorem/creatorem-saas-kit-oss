---
description: 
globs: 
alwaysApply: true
---
# Database Definition Guidelines

This guide outlines the database structure and organization for the project, focusing on Supabase and Drizzle implementations.

## Database Structure

### 1. Supabase Schema Definition
Location: `/supabase/migrations/**/*.sql`

These migration files define the core database structure:
- Table definitions
- Triggers
- Row Level Security (RLS) policies
- Kit functions
- Enumerated types

#### Default Tables
- `user`: Public table linked to `auth.users`
- `user_setting`: User-specific settings storage

### 2. Kit Schema
The kit schema provides reusable business logic components:

#### Core Components
- Business logic functions
- Role/permission management
- Data maintenance triggers
- Utility functions

## Schema Implementation

### 1. Supabase Schema
Location: `/supabase/migrations/**/*.sql`

#### When to Use
- Database structure modifications
- Policy updates
- Trigger implementations
- Function definitions

#### Key Files
- [schema.ts](mdc:packages/supabase/supabase-drizzle/src/drizzle/schema.ts)
- [relations.ts](mdc:packages/supabase/supabase-drizzle/src/drizzle/relations.ts)

### 2. Drizzle Implementation
Location: `kit/supabase/supabase-drizzle/src/drizzle/`

#### Components
1. **Schema Definition**
   - Table structures
   - Column definitions
   - Data types
   - Default values

2. **Relations**
   - Table relationships
   - Foreign key constraints
   - Join definitions

## Best Practices

### 1. Schema Updates
- Always use migration files for changes
- Follow naming conventions
- Document changes clearly
- Test migrations before deployment

### 2. Data Model Design
- Keep tables normalized
- Use appropriate data types
- Implement proper indexing
- Define clear relationships

### 3. Security
- Implement RLS policies
- Use appropriate permissions
- Follow least privilege principle
- Document security rules

## Common Operations

### 1. Adding New Tables
1. Create migration file
2. Define table structure
3. Add RLS policies
4. Update Drizzle schema
5. Test changes

### 2. Modifying Existing Tables
1. Create migration file
2. Define changes
3. Update related schemas
4. Test modifications

### 3. Adding Functions
1. Create function definition
2. Add to migration file
3. Document purpose
4. Test functionality

## Maintenance

### 1. Regular Tasks
- Review schema changes
- Update documentation
- Clean up unused tables
- Optimize performance

### 2. Documentation
- Keep schemas documented
- Update migration history
- Document relationships
- Maintain change log

## Troubleshooting

### 1. Common Issues
- Migration conflicts
- Schema mismatches
- Permission problems
- Relationship errors

### 2. Resolution Steps
1. Check migration history
2. Verify schema definitions
3. Review RLS policies
4. Test in development

Remember: Database structure is crucial for application stability. Keep schemas well-documented and maintain consistent patterns across the codebase.
