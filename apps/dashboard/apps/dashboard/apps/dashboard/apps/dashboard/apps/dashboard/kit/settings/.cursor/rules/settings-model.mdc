---
description: 
globs: 
alwaysApply: true
---
# Settings package

## Purpose

The settings package aims to simplify :
- database declaration entries
- zod schema type-checking on each different data
- handle different database storage method (e.g: user_setting table per row, user attribute per column, ...)
- deliver a simplify api to render input logic forms (with possiblity to provide complex jsx component)
- use typescript type-checking to provide as much autocompletion as needed to simplify the development experience.

Note: if you provide pure jsx component in your model, take care to handle mobile and browser environment if you want to use it in both environment.

## How it works ?

The idea is to declare a typescript object, a `model`, instanced server side (not env specific to make it work on mobile and web).

The `model` allows to define : 
- a database getter
- database updater
- communicate needed data to build a specific render api (specific for mobile or browser environment)

### The createSettingModel function

The createSettingModel add the default `user_settings` and `user_attributes` database provider methods.

`user_settings`: set/get data in the user_setting table as row entries.
`user_attributes`: set/get data in the user table as column entries.

The following example show a real world example of usage of the createSettingModel function.
It adds custom StorageProvider, define data zod schemas, show complex UI declaration.

Use case example : 
```typescript
import { and, eq, inArray, organizationSetting, organization as organizationTable } from '@kit/drizzle';
import { createSettingModel } from '@kit/settings';
import { Icon } from '@kit/ui/icon';
import { Separator } from '@kit/ui/separator';
import { Muted } from '@kit/ui/text';
import { camelCase } from 'lodash';
import { z } from 'zod';
import { AvatarPlaceholder } from '~/components/avatar-placeholder';
import { DangerZoneComponent } from '~/components/organizations/settings/user/danger-zone/danger-zone-component';
import { getDBClient } from '@kit/shared/server/get-db-client';
import { StorageProvider } from '../../../../kit/www/features/settings/src/setting-model';
import { OrganizationDBClient } from '@kit/organization/shared/server';

const organizationAttributesStorage: StorageProvider = {
    fetchFromStorage: async (rawKeys) => {
        const keysConverter = Object.fromEntries(
            rawKeys.map((key) => [camelCase(key.replace('organization_', '')), key])
        );
        const keys = Object.keys(keysConverter);
        const db = await getDBClient();
        const organizationClient = new OrganizationDBClient(db);
        const organization = await organizationClient.require();

        const settings: Record<string, any> = {};

        for (const key of keys) {
            if (!(key in organization)) {
                throw new Error(`Key ${key} not found in organization`);
            }
            settings[key] = organization[key as keyof typeof organization];
        }

        const originalSettings = Object.fromEntries(
            Object.entries(settings).map(([key, value]) => [keysConverter[key], value])
        );

        return originalSettings;
    },
    saveToStorage: async (rawValues) => {
        const values = Object.fromEntries(
            Object.entries(rawValues).map(([key, value]) => [
                camelCase(key.replace('organization_', '')),
                value,
            ])
        );

        const db = await getDBClient();
        await db.rls.transaction(async (tx) => {
            return await tx.update(organizationTable).set(values);
        });
    },
};

const organizationSettingsStorage: StorageProvider = {
    fetchFromStorage: async (keys) => {
        const db = await getDBClient();
        const result = await db.rls.transaction(async (tx) => {
            return await tx.select().from(organizationSetting).where(inArray(organizationSetting.name, keys));
        });

        const settings: Record<string, any> = {};

        for (const item of result) {
            settings[item.name] = item.value;
        }

        return settings;
    },
    saveToStorage: async (values) => {
        const db = await getDBClient();
        const organizationClient = new OrganizationDBClient(db);
        const organization = await organizationClient.require();

        await db.rls.transaction(async (tx) => {
            const settingValues = Object.entries(values).map(([name, value]) => ({
                name,
                value,
                organizationId: organization.id,
            }));

            const t = organizationSetting.name;

            // Check if setting exists first, then insert or update
            for (const setting of settingValues) {
                // First try to find if the setting already exists
                const existingSetting = await tx
                    .select()
                    .from(organizationSetting)
                    .where(
                        and(
                            eq(organizationSetting.name, setting.name),
                            eq(organizationSetting.organizationId, setting.organizationId)
                        )
                    )
                    .limit(1);

                if (existingSetting.length > 0) {
                    // Setting exists, update it
                    await tx
                        .update(organizationSetting)
                        .set({
                            value: setting.value,
                            updatedAt: new Date().toISOString(),
                        })
                        .where(
                            and(
                                eq(organizationSetting.name, setting.name),
                                eq(organizationSetting.organizationId, setting.organizationId)
                            )
                        );
                } else {
                    // Setting doesn't exist, insert it
                    await tx.insert(organizationSetting).values(setting);
                }
            }
        });
    },
};

export const settingsModel = createSettingModel(
    getDBClient,
    {
        // User Profile Settings
        user_profile_url: {
            schema: z.string().nullable().default(null),
            storage: 'user_attributes',
        },
        user_name: {
            schema: z.string().default(''),
            storage: 'user_attributes',
        },
        user_email: {
            schema: z.string().email().nullable().default(null),
            storage: 'user_attributes',
        },
        user_phone: {
            schema: z.string().nullable().default(null),
            storage: 'user_attributes',
        },
        user_locale: {
            schema: z.enum(['en-US', 'fr-FR']).default('en-US'),
            storage: 'user_attributes',
        },
        user_bio: {
            schema: z.string().max(500).default(''),
            storage: 'user_settings',
        },

        // Appearance Settings
        theme: {
            schema: z.enum(['light', 'dark', 'system']),
            storage: 'user_settings',
        },
        accent_color: {
            schema: z.string().default('#0284c7'),
            storage: 'user_settings',
        },

        // Notification Settings
        email_notifications: {
            schema: z.boolean().default(true),
            storage: 'user_settings',
        },
        push_notifications: {
            schema: z.boolean().default(true),
            storage: 'user_settings',
        },
        notification_frequency: {
            schema: z.enum(['immediate', 'daily', 'weekly']).default('immediate'),
            storage: 'user_settings',
        },

        // Contact Settings
        contact_phone: {
            schema: z.string().nullable().default(null),
            storage: 'user_settings',
        },
        emergency_contact_phone: {
            schema: z.string().nullable().default(null),
            storage: 'user_settings',
        },

        // Time Settings
        working_hours_start: {
            schema: z.string().default('09:00'),
            storage: 'user_settings',
        },
        working_hours_end: {
            schema: z.string().default('17:00'),
            storage: 'user_settings',
        },

        // Numeric Settings
        max_items_per_page: {
            schema: z.number().min(5).max(100).default(20),
            storage: 'user_settings',
        },

        // API Settings
        api_key: {
            schema: z.string().default(''),
            storage: 'user_settings',
        },

        // Organization Settings
        organization_logo_url: {
            schema: z.string().default(''),
            storage: 'organization_attributes',
        },
        organization_name: {
            schema: z.string().default(''),
            storage: 'organization_attributes',
        },
        org_phone: {
            schema: z.string().default(''),
            // stored in the organization_settings table
            // remove the phone def here and the ui desc below to remove it.
            storage: 'organization_settings',
        },
    },
    [
        {
            group: 'index',
            label: 'About you',
            settingsPages: [
                {
                    // match : "/" endpoint
                    slug: 'index',
                    icon: <Icon.user className="h-4 w-4" />,
                    title: 'Profile',
                    description: 'User profile settings',
                    settings: [
                        {
                            type: 'wrapper',
                            header: (
                                <>
                                    <div className="text-2xl font-bold">Profile</div>
                                    <Muted>Edit your profile information here.</Muted>
                                </>
                            ),
                            settings: [
                                {
                                    type: 'wrapper',
                                    className:
                                        'p-0 flex flex-col gap-4 md:flex-row-reverse md:justify-end md:gap-10',
                                    settings: [
                                        {
                                            type: 'user_media',
                                            slug: 'user_profile_url',
                                            label: 'Profile URL',
                                            triggerClassName: 'h-48 w-48 rounded-full',
                                            imageClassName: 'w-full h-full object-cover',
                                            placeholder: <AvatarPlaceholder className="size-full text-6xl" />,
                                        },
                                        {
                                            type: 'wrapper',
                                            className: 'p-0 flex-1 max-w-lg',
                                            settings: [
                                                {
                                                    type: 'text',
                                                    slug: 'user_name',
                                                    label: 'Name',
                                                    description:
                                                        'May appear when you are mentioned or when you add content to the platform',
                                                },
                                                {
                                                    type: 'text',
                                                    slug: 'user_email',
                                                    label: 'Email',
                                                    description: 'Required for login and notifications',
                                                },
                                                {
                                                    type: 'phone',
                                                    slug: 'user_phone',
                                                    label: 'Phone',
                                                    description: 'Used for authentication purposes only',
                                                },
                                            ],
                                        },
                                    ],
                                },
                                {
                                    type: 'select',
                                    slug: 'user_locale',
                                    label: 'Locale',
                                    options: [
                                        {
                                            label: (
                                                <div className="flex items-center gap-2">
                                                    <Icon.gbFlag className="h-4 w-4" />
                                                    English
                                                </div>
                                            ),
                                            value: 'en-US',
                                        },
                                        {
                                            label: (
                                                <div className="flex items-center gap-2">
                                                    <Icon.frFlag className="h-4 w-4" />
                                                    French
                                                </div>
                                            ),
                                            value: 'fr-FR',
                                        },
                                    ],
                                },
                                {
                                    type: 'textarea',
                                    slug: 'user_bio',
                                    label: 'Bio',
                                    description: 'Tell us more about yourself',
                                },
                            ],
                        },
                        {
                            type: 'ui',
                            render: <Separator />,
                        },
                        {
                            type: 'wrapper',
                            header: (
                                <>
                                    <div className="text-2xl font-bold">Appearance</div>
                                    <Muted>Customize your appearance settings.</Muted>
                                </>
                            ),
                            settings: [
                                // appearance
                                {
                                    type: 'theme',
                                    slug: 'theme',
                                    label: 'Theme',
                                    description: 'Choose your preferred theme',
                                    descriptionPosition: 'above',
                                },
                                {
                                    type: 'color',
                                    slug: 'accent_color',
                                    label: 'Accent Color',
                                    description: 'Choose your preferred accent color',
                                },
                                // Test UI component
                                {
                                    type: 'ui',
                                    render: <div className="py-2 text-sm">Custom UI element</div>,
                                },
                                // Test parent wrapper
                                {
                                    type: 'wrapper',
                                    className: 'my-4 rounded-sm border p-4',
                                    header: <h3 className="mb-2 text-lg font-medium">Nested Settings</h3>,
                                    settings: [
                                        // These should still have proper type checking and autocompletion
                                        {
                                            type: 'text',
                                            slug: 'user_name',
                                            label: 'Name (nested)',
                                        },
                                    ],
                                },
                            ],
                        },
                        {
                            type: 'ui',
                            render: <Separator className="my-6" />,
                        },
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'ui',
                                    render: <DangerZoneComponent className="my-6" />,
                                },
                            ],
                        },
                    ],
                },
                {
                    slug: 'security',
                    title: 'Security',
                    icon: <Icon.lock className="h-4 w-4" />,
                    description: 'Manage your security settings',
                    settings: [
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'phone',
                                    slug: 'contact_phone',
                                    label: 'Contact Phone',
                                    description: 'Your primary contact phone number',
                                },
                                {
                                    type: 'phone',
                                    slug: 'emergency_contact_phone',
                                    label: 'Emergency Contact',
                                    description: 'Phone number for emergencies',
                                },
                            ],
                        },
                    ],
                },
                {
                    // match : "/notifications" endpoint
                    slug: 'notifications',
                    title: 'Notifications',
                    icon: <Icon name="Bell" className="h-4 w-4" />,
                    description: 'Configure how and when you receive notifications',
                    settings: [
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'boolean',
                                    slug: 'email_notifications',
                                    label: 'Email Notifications',
                                    description: 'Receive notifications via email',
                                },
                                {
                                    type: 'boolean',
                                    slug: 'push_notifications',
                                    label: 'Push Notifications',
                                    description: 'Receive push notifications on your devices',
                                },
                                {
                                    type: 'radio',
                                    slug: 'notification_frequency',
                                    label: 'Notification Frequency',
                                    description: 'How often would you like to receive notifications?',
                                    options: [
                                        {
                                            label: 'Immediate',
                                            value: 'immediate',
                                        },
                                        {
                                            label: 'Daily Digest',
                                            value: 'daily',
                                        },
                                        {
                                            label: 'Weekly Digest',
                                            value: 'weekly',
                                        },
                                    ],
                                },
                            ],
                        },
                    ],
                },
            ],
        },
        {
            group: 'organization',
            label: 'Organization',
            settingsPages: [
                {
                    // match : "/advanced" endpoint
                    slug: 'index',
                    title: 'General',
                    icon: <Icon name="Store" className="h-4 w-4" />,
                    description: 'Configure organization settings',
                    settings: [
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'text',
                                    slug: 'organization_logo_url',
                                    label: 'Logo URL',
                                    placeholder: 'https://example.com/logo.png',
                                },
                                {
                                    type: 'text',
                                    slug: 'organization_name',
                                    label: 'Name',
                                    placeholder: 'My Organization',
                                },
                                {
                                    type: 'phone',
                                    slug: 'org_phone',
                                    label: 'Phone',
                                },
                            ],
                        },
                    ],
                },
                {
                    slug: 'members',
                    title: 'Members',
                    icon: <Icon name="Users" className="h-4 w-4" />,
                    description: 'Manage organization members',
                    settings: [
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'text',
                                    slug: 'api_key',
                                    label: 'API Key',
                                    description: 'API key for the application',
                                },
                            ],
                        },
                    ],
                },
                {
                    slug: 'billing',
                    title: 'Billing',
                    icon: <Icon name="CreditCard" className="h-4 w-4" />,
                    description: 'Manage organization billing',
                    settings: [
                        {
                            type: 'wrapper',
                            settings: [
                                {
                                    type: 'text',
                                    slug: 'api_key',
                                    label: 'API Key',
                                    description: 'API key for the application',
                                },
                            ],
                        },
                    ],
                },
            ],
        },
    ],
    // storage autocompletion doesn't work without this
    {
        organization_attributes: organizationAttributesStorage,
        organization_settings: organizationSettingsStorage,
    }
);
```

