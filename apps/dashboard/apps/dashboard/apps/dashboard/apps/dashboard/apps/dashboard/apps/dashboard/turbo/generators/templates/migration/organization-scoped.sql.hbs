/*
 * ---------------------------------------------------------------------------------
 * {{ properCase tableName }} Table Schema
 * ---------------------------------------------------------------------------------
 *
 * Purpose: Store {{ lowerCase tableName }} data for organizations
 *
 * Table of contents:
 * - {{ properCase tableName }} table
 * - {{ properCase tableName }} Comments
 * - {{ properCase tableName }} Permissions
 * - {{ properCase tableName }} RLS Policies
 * - {{ properCase tableName }} Triggers
 *
 * Dependencies:
 * - 031-kit-org.sql (organizations table)
 * - 034-organization-members.sql (members table for organization access)
 */

------------------------------------- {{ upperCase tableName }} TABLE -------------------------------------

/*
 * {{ upperCase tableName }} TABLE:
 * This table contains the {{ lowerCase tableName }} data for organizations.
 */
CREATE TABLE IF NOT EXISTS "public"."{{ tableName }}" (
    id uuid unique not null default extensions.uuid_generate_v4(),
    organization_id uuid references public.organization (id) on delete cascade not null,
    -- Add your columns here
    -- Example:
    -- name varchar(255) not null,
    -- value text,
    updated_at timestamptz DEFAULT "now"() NOT NULL,
    created_at timestamptz DEFAULT "now"() NOT NULL,
    primary key (id)
);

------------------------------------- TABLE COMMENTS -------------------------------------

COMMENT ON TABLE "public"."{{ tableName }}" IS 'Allow to store {{ lowerCase tableName }} data for organizations';
-- Add column comments here
-- Example:
-- COMMENT ON COLUMN "public"."{{ tableName }}"."name" IS 'The name of the {{ lowerCase tableName }}';

------------------------------------- PERMISSIONS -------------------------------------

-- Reset the RLS access to authenticated and service_role roles
REVOKE all on public.{{ tableName }} from authenticated, service_role;
GRANT select, insert, update, delete on table public.{{ tableName }} to authenticated, service_role;

-- Enable RLS on the {{ tableName }} table
ALTER TABLE public.{{ tableName }} ENABLE ROW LEVEL SECURITY;

------------------------------------- RLS POLICIES -------------------------------------

/*
 * {{ properCase tableName }} access policy
 * Users can access {{ lowerCase tableName }} data if they are members of the organization
 * and have the necessary permission (organization.manage by default)
 *
 * Note: You may want to create a custom permission like '{{ tableName }}.manage'
 * in supabase/schemas/030-organization-enums.sql for fine-grained control
 */
CREATE POLICY {{ tableName }}_all ON public.{{ tableName }}
FOR ALL TO authenticated
USING (
  kit.user_is_member_of_org(organization_id) AND
  kit.has_org_permission(organization_id, 'organization.manage'::org_permission)
)
WITH CHECK (
  kit.user_is_member_of_org(organization_id) AND
  kit.has_org_permission(organization_id, 'organization.manage'::org_permission)
);

------------------------------------- TRIGGERS -------------------------------------

/*
 * Trigger: Update timestamp on {{ tableName }} changes
 * Automatically updates updated_at field when {{ tableName }} is modified
 */
create trigger reset_updated_at_on_{{ tableName }}_on_update
after update on public.{{ tableName }} for each row
execute procedure kit.reset_updated_at ();
